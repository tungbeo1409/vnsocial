<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test K·∫øt b·∫°n - Safe Runner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }
    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }
    .content {
      padding: 30px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      flex: 1;
      min-width: 150px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    .btn-secondary {
      background: #6b7280;
      color: white;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    .btn-success {
      background: #10b981;
      color: white;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }
    .log-container {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .log-item {
      margin-bottom: 8px;
      padding: 4px 0;
    }
    .log-success { color: #4ade80; }
    .log-error { color: #f87171; }
    .log-info { color: #60a5fa; }
    .log-warning { color: #fbbf24; }
    .log-step { 
      color: #a78bfa; 
      font-weight: bold;
      margin-top: 12px;
    }
    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .status.pending { background: #fef3c7; color: #92400e; }
    .status.running { background: #dbeafe; color: #1e40af; }
    .status.success { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üß™ Test Ch·ª©c nƒÉng K·∫øt b·∫°n</h1>
      <p>An to√†n - Kh√¥ng c·∫ßn paste code v√†o Console</p>
    </div>
    
    <div class="content">
      <div id="status" class="status pending">
        ‚è≥ S·∫µn s√†ng - Click "Ch·∫°y Test" ƒë·ªÉ b·∫Øt ƒë·∫ßu
      </div>
      
      <div class="button-group">
        <button class="btn-primary" onclick="runFullTest()">
          ‚ñ∂Ô∏è Ch·∫°y Test ƒê·∫ßy ƒê·ªß
        </button>
        <button class="btn-secondary" onclick="clearLog()">
          üóëÔ∏è X√≥a Log
        </button>
        <button class="btn-success" onclick="checkRules()">
          üîç Ki·ªÉm tra Rules
        </button>
      </div>
      
      <div id="log" class="log-container"></div>
    </div>
  </div>

  <script type="module">
    const logEl = document.getElementById('log')
    const statusEl = document.getElementById('status')
    
    // Check if running from dev server
    const isDevServer = window.location.protocol === 'http:' || window.location.protocol === 'https:'
    const basePath = isDevServer ? window.location.origin : 'http://localhost:5173'
    
    function addLog(message, type = 'info') {
      const div = document.createElement('div')
      div.className = `log-item log-${type}`
      div.textContent = message
      logEl.appendChild(div)
      logEl.scrollTop = logEl.scrollHeight
    }
    
    function setStatus(text, type) {
      statusEl.textContent = text
      statusEl.className = `status ${type}`
    }
    
    window.clearLog = () => {
      logEl.innerHTML = ''
      setStatus('‚è≥ S·∫µn s√†ng - Click "Ch·∫°y Test" ƒë·ªÉ b·∫Øt ƒë·∫ßu', 'pending')
    }
    
    window.checkRules = async () => {
      clearLog()
      setStatus('üîç ƒêang ki·ªÉm tra Firestore Rules...', 'running')
      addLog('üìã Ki·ªÉm tra Firestore Rules', 'step')
      addLog('', 'info')
      addLog('1. V√†o Firebase Console: https://console.firebase.google.com/', 'info')
      addLog('2. Ch·ªçn project: news-eff0b', 'info')
      addLog('3. V√†o Firestore Database > Rules', 'info')
      addLog('4. Copy rules t·ª´ file: FIRESTORE_RULES_FIXED.txt', 'info')
      addLog('5. Paste v√† Publish', 'info')
      addLog('', 'info')
      addLog('‚úÖ Rules c·∫ßn c√≥:', 'success')
      addLog('   - allow read: if true (cho users)', 'info')
      addLog('   - allow update: if request.auth != null && (...)', 'info')
      addLog('   - Cho ph√©p update friendRequests, friends, sentRequests', 'info')
      setStatus('‚úÖ H∆∞·ªõng d·∫´n ƒë√£ hi·ªÉn th·ªã', 'success')
    }
    
    window.runFullTest = async () => {
      clearLog()
      setStatus('üîÑ ƒêang ch·∫°y test...', 'running')
      
      // Check if running from file://
      if (!isDevServer) {
        addLog('‚ö†Ô∏è  C·∫¢NH B√ÅO: File ƒëang ch·∫°y t·ª´ file://', 'warning')
        addLog('', 'info')
        addLog('üìã C√ÅCH S·ª¨A:', 'step')
        addLog('1. ƒê·∫£m b·∫£o dev server ƒëang ch·∫°y: npm run dev', 'info')
        addLog('2. M·ªü file n√†y t·ª´ dev server:', 'info')
        addLog(`   ‚Üí ${basePath}/test-runner.html`, 'info')
        addLog('', 'info')
        addLog('HO·∫∂C:', 'step')
        addLog('M·ªü Console (F12) trong tab ·ª©ng d·ª•ng ch√≠nh v√† ch·∫°y:', 'info')
        addLog('', 'info')
        addLog('const {useAuthStore}=await import("./src/stores/auth.js");', 'info')
        addLog('const {useFriendsStore}=await import("./src/stores/friends.js");', 'info')
        addLog('const {db}=await import("./src/config/firebase.js");', 'info')
        addLog('const {doc,getDoc,collection,getDocs}=await import("firebase/firestore");', 'info')
        addLog('const authStore=useAuthStore();', 'info')
        addLog('const friendsStore=useFriendsStore();', 'info')
        addLog('if(!authStore.user){console.error("Ch∆∞a ƒëƒÉng nh·∫≠p!");}else{const snapshot=await getDocs(collection(db,"users"));const others=[];snapshot.forEach(d=>{if(d.id!==authStore.user.uid)others.push({id:d.id,...d.data()})});if(others.length>0){const result=await friendsStore.sendFriendRequest(authStore.user.uid,others[0].id);console.log("K·∫øt qu·∫£:",result);}}', 'info')
        setStatus('‚ùå C·∫ßn ch·∫°y t·ª´ dev server', 'error')
        return
      }
      
      try {
        addLog('üß™ B·∫ÆT ƒê·∫¶U TEST CH·ª®C NƒÇNG K·∫æT B·∫†N', 'step')
        addLog('='.repeat(50), 'info')
        
        // Step 1: Import
        addLog('', 'info')
        addLog('üì¶ Step 1: Import modules...', 'step')
        const { useAuthStore } = await import('./src/stores/auth.js')
        const { useFriendsStore } = await import('./src/stores/friends.js')
        const { db } = await import('./src/config/firebase.js')
        const { doc, getDoc, collection, getDocs } = await import('firebase/firestore')
        
        const authStore = useAuthStore()
        const friendsStore = useFriendsStore()
        addLog('‚úÖ Modules imported', 'success')
        
        // Step 2: Check auth
        addLog('', 'info')
        addLog('üîê Step 2: Ki·ªÉm tra authentication...', 'step')
        if (!authStore.user) {
          addLog('‚ùå CH∆ØA ƒêƒÇNG NH·∫¨P!', 'error')
          addLog('   ‚Üí Vui l√≤ng ƒëƒÉng nh·∫≠p v√†o ·ª©ng d·ª•ng tr∆∞·ªõc', 'warning')
          addLog('   ‚Üí Sau ƒë√≥ quay l·∫°i v√† ch·∫°y test l·∫°i', 'warning')
          setStatus('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p', 'error')
          return
        }
        addLog(`‚úÖ User: ${authStore.user.email}`, 'success')
        addLog(`‚úÖ UID: ${authStore.user.uid}`, 'success')
        
        // Step 3: Test read
        addLog('', 'info')
        addLog('üìñ Step 3: Test quy·ªÅn ƒë·ªçc user profile...', 'step')
        try {
          const userDoc = await getDoc(doc(db, 'users', authStore.user.uid))
          if (!userDoc.exists()) {
            addLog('‚ùå User profile kh√¥ng t·ªìn t·∫°i!', 'error')
            setStatus('‚ùå Profile kh√¥ng t·ªìn t·∫°i', 'error')
            return
          }
          const userData = userDoc.data()
          addLog('‚úÖ ƒê·ªçc ƒë∆∞·ª£c profile', 'success')
          addLog(`   - Display Name: ${userData.displayName || 'N/A'}`, 'info')
          addLog(`   - Friends: ${userData.friends?.length || 0}`, 'info')
          addLog(`   - Friend Requests: ${userData.friendRequests?.length || 0}`, 'info')
          addLog(`   - Sent Requests: ${userData.sentRequests?.length || 0}`, 'info')
        } catch (error) {
          addLog(`‚ùå L·ªói ƒë·ªçc profile: ${error.message}`, 'error')
          addLog('   ‚Üí C√≥ th·ªÉ do Firestore Rules ch∆∞a cho ph√©p ƒë·ªçc', 'warning')
          addLog('   ‚Üí Click "Ki·ªÉm tra Rules" ƒë·ªÉ xem h∆∞·ªõng d·∫´n', 'warning')
          setStatus('‚ùå L·ªói ƒë·ªçc profile', 'error')
          return
        }
        
        // Step 4: Find other user
        addLog('', 'info')
        addLog('üîç Step 4: T√¨m user kh√°c ƒë·ªÉ test...', 'step')
        const usersRef = collection(db, 'users')
        const snapshot = await getDocs(usersRef)
        
        const otherUsers = []
        snapshot.forEach((doc) => {
          if (doc.id !== authStore.user.uid) {
            otherUsers.push({ id: doc.id, ...doc.data() })
          }
        })
        
        if (otherUsers.length === 0) {
          addLog('‚ùå Kh√¥ng t√¨m th·∫•y user n√†o kh√°c!', 'error')
          addLog('   ‚Üí T·∫°o t√†i kho·∫£n kh√°c ƒë·ªÉ test', 'warning')
          setStatus('‚ùå Kh√¥ng c√≥ user ƒë·ªÉ test', 'error')
          return
        }
        
        const testUser = otherUsers[0]
        addLog(`‚úÖ T√¨m th·∫•y user: ${testUser.displayName}`, 'success')
        addLog(`   - ID: ${testUser.id}`, 'info')
        addLog(`   - Username: ${testUser.username || 'N/A'}`, 'info')
        
        // Step 5: Check status
        addLog('', 'info')
        addLog('ü§ù Step 5: Ki·ªÉm tra friendship status...', 'step')
        const status = await friendsStore.getFriendshipStatus(authStore.user.uid, testUser.id)
        addLog(`‚úÖ Status: ${status}`, 'success')
        
        // Step 6: Test send request
        addLog('', 'info')
        addLog('üì§ Step 6: Test g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n...', 'step')
        
        if (status === 'none') {
          addLog('   ‚Üí ƒêang g·ª≠i l·ªùi m·ªùi...', 'info')
          const result = await friendsStore.sendFriendRequest(authStore.user.uid, testUser.id)
          
          if (result.success) {
            addLog('‚úÖ G·ª≠i l·ªùi m·ªùi th√†nh c√¥ng!', 'success')
            
            // Wait for update
            addLog('   ‚Üí ƒêang ƒë·ª£i Firestore c·∫≠p nh·∫≠t...', 'info')
            await new Promise(resolve => setTimeout(resolve, 1500))
            
            // Verify
            addLog('', 'info')
            addLog('üîç Step 7: Verify d·ªØ li·ªáu...', 'step')
            const senderDoc = await getDoc(doc(db, 'users', authStore.user.uid))
            const senderData = senderDoc.data()
            const receiverDoc = await getDoc(doc(db, 'users', testUser.id))
            const receiverData = receiverDoc.data()
            
            addLog(`   Sender sentRequests: ${JSON.stringify(senderData.sentRequests || [])}`, 'info')
            addLog(`   Receiver friendRequests: ${JSON.stringify(receiverData.friendRequests || [])}`, 'info')
            
            const senderHasRequest = senderData.sentRequests?.includes(testUser.id)
            const receiverHasRequest = receiverData.friendRequests?.includes(authStore.user.uid)
            
            if (senderHasRequest && receiverHasRequest) {
              addLog('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng!', 'success')
              addLog('', 'info')
              addLog('üéâ TEST TH√ÄNH C√îNG!', 'success')
              setStatus('‚úÖ Test th√†nh c√¥ng!', 'success')
            } else {
              addLog('‚ùå D·ªØ li·ªáu ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng!', 'error')
              addLog('   ‚Üí C√≥ th·ªÉ do Firestore Rules ch∆∞a cho ph√©p update', 'warning')
              addLog('   ‚Üí Click "Ki·ªÉm tra Rules" ƒë·ªÉ xem h∆∞·ªõng d·∫´n', 'warning')
              setStatus('‚ùå D·ªØ li·ªáu ch∆∞a update', 'error')
            }
          } else {
            addLog(`‚ùå G·ª≠i l·ªùi m·ªùi th·∫•t b·∫°i: ${result.error}`, 'error')
            addLog('   ‚Üí C√≥ th·ªÉ do Firestore Rules ch∆∞a cho ph√©p update', 'warning')
            addLog('   ‚Üí Click "Ki·ªÉm tra Rules" ƒë·ªÉ xem h∆∞·ªõng d·∫´n', 'warning')
            setStatus('‚ùå G·ª≠i l·ªùi m·ªùi th·∫•t b·∫°i', 'error')
          }
        } else if (status === 'sent') {
          addLog('‚ö†Ô∏è  ƒê√£ g·ª≠i l·ªùi m·ªùi r·ªìi', 'warning')
          addLog('   ‚Üí Test h·ªßy l·ªùi m·ªùi...', 'info')
          const result = await friendsStore.cancelFriendRequest(authStore.user.uid, testUser.id)
          if (result.success) {
            addLog('‚úÖ H·ªßy l·ªùi m·ªùi th√†nh c√¥ng!', 'success')
            setStatus('‚úÖ Test th√†nh c√¥ng!', 'success')
          } else {
            addLog(`‚ùå H·ªßy l·ªùi m·ªùi th·∫•t b·∫°i: ${result.error}`, 'error')
            setStatus('‚ùå H·ªßy l·ªùi m·ªùi th·∫•t b·∫°i', 'error')
          }
        } else if (status === 'friends') {
          addLog('‚ö†Ô∏è  ƒê√£ l√† b·∫°n b√® r·ªìi!', 'warning')
          setStatus('‚úÖ ƒê√£ l√† b·∫°n b√®', 'success')
        } else if (status === 'received') {
          addLog('‚ö†Ô∏è  ƒê√£ nh·∫≠n l·ªùi m·ªùi t·ª´ user n√†y!', 'warning')
          addLog('   ‚Üí Test ch·∫•p nh·∫≠n l·ªùi m·ªùi...', 'info')
          const result = await friendsStore.acceptFriendRequest(authStore.user.uid, testUser.id)
          if (result.success) {
            addLog('‚úÖ Ch·∫•p nh·∫≠n l·ªùi m·ªùi th√†nh c√¥ng!', 'success')
            setStatus('‚úÖ Test th√†nh c√¥ng!', 'success')
          } else {
            addLog(`‚ùå Ch·∫•p nh·∫≠n l·ªùi m·ªùi th·∫•t b·∫°i: ${result.error}`, 'error')
            setStatus('‚ùå Ch·∫•p nh·∫≠n th·∫•t b·∫°i', 'error')
          }
        }
        
      } catch (error) {
        addLog('', 'info')
        addLog(`‚ùå L·ªñI: ${error.message}`, 'error')
        addLog(`   Stack: ${error.stack}`, 'error')
        setStatus('‚ùå C√≥ l·ªói x·∫£y ra', 'error')
      }
    }
  </script>
</body>
</html>

