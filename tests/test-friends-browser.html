<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Ch·ª©c nƒÉng K·∫øt b·∫°n</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #2563eb;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .info { color: #60a5fa; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>üß™ Test Ch·ª©c nƒÉng K·∫øt b·∫°n</h1>
    <p>Ch·∫°y test ƒë·ªÉ ki·ªÉm tra ch·ª©c nƒÉng k·∫øt b·∫°n t·ª´ ƒë·∫ßu ƒë·∫øn cu·ªëi</p>
    
    <button onclick="runTest()">‚ñ∂Ô∏è Ch·∫°y Test</button>
    <button onclick="clearLog()">üóëÔ∏è X√≥a Log</button>
    
    <div id="log" class="log"></div>
  </div>

  <script type="module">
    const log = document.getElementById('log')
    
    function addLog(message, type = 'info') {
      const div = document.createElement('div')
      div.className = type
      div.textContent = message
      log.appendChild(div)
      log.scrollTop = log.scrollHeight
    }
    
    window.clearLog = () => {
      log.innerHTML = ''
    }
    
    window.runTest = async () => {
      clearLog()
      addLog('üß™ B·∫Øt ƒë·∫ßu test ch·ª©c nƒÉng k·∫øt b·∫°n...\n', 'info')
      
      try {
        // Import stores
        const { useAuthStore } = await import('./src/stores/auth.js')
        const { useFriendsStore } = await import('./src/stores/friends.js')
        const { db } = await import('./src/config/firebase.js')
        const { doc, getDoc, collection, getDocs } = await import('firebase/firestore')
        
        const authStore = useAuthStore()
        
        // Test 1: Check authentication
        addLog('üìã Test 1: Ki·ªÉm tra user ƒë√£ ƒëƒÉng nh·∫≠p', 'info')
        if (!authStore.user) {
          addLog('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p! Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc.', 'error')
          addLog('   ‚Üí V√†o trang web v√† ƒëƒÉng nh·∫≠p, sau ƒë√≥ quay l·∫°i test', 'info')
          return
        }
        addLog(`‚úÖ User ƒë√£ ƒëƒÉng nh·∫≠p: ${authStore.user.uid}`, 'success')
        addLog(`‚úÖ Email: ${authStore.user.email}`, 'success')
        
        // Test 2: Check read permission
        addLog('\nüìã Test 2: Ki·ªÉm tra quy·ªÅn ƒë·ªçc user profile', 'info')
        try {
          const userDoc = await getDoc(doc(db, 'users', authStore.user.uid))
          if (userDoc.exists()) {
            const userData = userDoc.data()
            addLog('‚úÖ ƒê·ªçc ƒë∆∞·ª£c user profile', 'success')
            addLog(`   - friends: ${(userData.friends || []).length}`, 'info')
            addLog(`   - friendRequests: ${(userData.friendRequests || []).length}`, 'info')
            addLog(`   - sentRequests: ${(userData.sentRequests || []).length}`, 'info')
          } else {
            addLog('‚ùå User profile kh√¥ng t·ªìn t·∫°i!', 'error')
            return
          }
        } catch (error) {
          addLog(`‚ùå L·ªói ƒë·ªçc user profile: ${error.message}`, 'error')
          addLog('   ‚Üí C√≥ th·ªÉ do Firestore Rules ch∆∞a cho ph√©p ƒë·ªçc', 'error')
          addLog('   ‚Üí Ki·ªÉm tra Rules trong Firebase Console', 'info')
          return
        }
        
        // Test 3: Find other user
        addLog('\nüìã Test 3: T√¨m user kh√°c ƒë·ªÉ test', 'info')
        const usersRef = collection(db, 'users')
        const snapshot = await getDocs(usersRef)
        
        const otherUsers = []
        snapshot.forEach((doc) => {
          if (doc.id !== authStore.user.uid) {
            otherUsers.push({ id: doc.id, ...doc.data() })
          }
        })
        
        if (otherUsers.length === 0) {
          addLog('‚ùå Kh√¥ng t√¨m th·∫•y user n√†o kh√°c ƒë·ªÉ test!', 'error')
          addLog('   ‚Üí T·∫°o t√†i kho·∫£n kh√°c ƒë·ªÉ test', 'info')
          return
        }
        
        const testUser = otherUsers[0]
        addLog(`‚úÖ T√¨m th·∫•y user ƒë·ªÉ test: ${testUser.displayName} (${testUser.id})`, 'success')
        
        // Test 4: Check friendship status
        addLog('\nüìã Test 4: Ki·ªÉm tra friendship status', 'info')
        const friendsStore = useFriendsStore()
        const status = await friendsStore.getFriendshipStatus(authStore.user.uid, testUser.id)
        addLog(`‚úÖ Friendship status: ${status}`, 'success')
        
        // Test 5: Test send friend request
        addLog('\nüìã Test 5: Test g·ª≠i l·ªùi m·ªùi k·∫øt b·∫°n', 'info')
        if (status === 'none') {
          addLog('   ‚Üí ƒêang g·ª≠i l·ªùi m·ªùi...', 'info')
          const result = await friendsStore.sendFriendRequest(authStore.user.uid, testUser.id)
          
          if (result.success) {
            addLog('‚úÖ G·ª≠i l·ªùi m·ªùi th√†nh c√¥ng!', 'success')
            
            // Verify data
            await new Promise(resolve => setTimeout(resolve, 1000)) // Wait for update
            
            const userDoc = await getDoc(doc(db, 'users', authStore.user.uid))
            const userData = userDoc.data()
            const otherUserDoc = await getDoc(doc(db, 'users', testUser.id))
            const otherUserData = otherUserDoc.data()
            
            addLog(`   - sentRequests: ${JSON.stringify(userData.sentRequests || [])}`, 'info')
            addLog(`   - friendRequests c·ªßa ng∆∞·ªùi nh·∫≠n: ${JSON.stringify(otherUserData.friendRequests || [])}`, 'info')
            
            if (userData.sentRequests?.includes(testUser.id) && 
                otherUserData.friendRequests?.includes(authStore.user.uid)) {
              addLog('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng!', 'success')
            } else {
              addLog('‚ùå D·ªØ li·ªáu ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë√∫ng!', 'error')
              addLog('   ‚Üí C√≥ th·ªÉ do Firestore Rules ch∆∞a cho ph√©p update', 'error')
            }
          } else {
            addLog(`‚ùå G·ª≠i l·ªùi m·ªùi th·∫•t b·∫°i: ${result.error}`, 'error')
            addLog('   ‚Üí C√≥ th·ªÉ do Firestore Rules ch∆∞a cho ph√©p update', 'error')
            addLog('   ‚Üí Xem file FIRESTORE_RULES_FIXED.txt ƒë·ªÉ c·∫≠p nh·∫≠t Rules', 'info')
          }
        } else if (status === 'sent') {
          addLog('‚ö†Ô∏è  ƒê√£ g·ª≠i l·ªùi m·ªùi r·ªìi, ƒëang h·ªßy...', 'info')
          const result = await friendsStore.cancelFriendRequest(authStore.user.uid, testUser.id)
          if (result.success) {
            addLog('‚úÖ H·ªßy l·ªùi m·ªùi th√†nh c√¥ng!', 'success')
          } else {
            addLog(`‚ùå H·ªßy l·ªùi m·ªùi th·∫•t b·∫°i: ${result.error}`, 'error')
          }
        } else {
          addLog(`‚ö†Ô∏è  Status: ${status} - Kh√¥ng th·ªÉ test g·ª≠i l·ªùi m·ªùi`, 'info')
        }
        
        // Summary
        addLog('\n‚úÖ Test ho√†n t·∫•t!', 'success')
        addLog('\nüìù T√≥m t·∫Øt:', 'info')
        addLog('   1. ‚úÖ User authentication', 'success')
        addLog('   2. ‚úÖ Read user profile', 'success')
        addLog('   3. ‚ö†Ô∏è  Send friend request - C·∫ßn ki·ªÉm tra Rules', 'info')
        addLog('   4. ‚ö†Ô∏è  Update arrays - C·∫ßn ki·ªÉm tra Rules', 'info')
        addLog('\nüí° N·∫øu l·ªói, ki·ªÉm tra Firestore Rules trong Firebase Console', 'info')
        
      } catch (error) {
        addLog(`‚ùå L·ªói: ${error.message}`, 'error')
        addLog(`   Stack: ${error.stack}`, 'error')
      }
    }
  </script>
</body>
</html>

